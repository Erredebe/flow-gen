<div class="app-shell" [class.dark-mode]="darkMode">
  <header class="topbar glass">
    <div class="brand">
      <h1>iv-flow</h1>
      <p>Editor visual de automatizaci√≥n e IA</p>
    </div>
    <div class="actions">
      <input [(ngModel)]="flowName" placeholder="Nombre del flujo" />
      <button class="primary" (click)="newFlow()">Nuevo</button>
      <button (click)="undo()">Deshacer</button>
      <button (click)="redo()">Rehacer</button>
      <button (click)="validateFlow()">Validar</button>
      <button class="primary" (click)="runFlow()" [disabled]="running">Run</button>
      <button (click)="saveFlow()">Guardar</button>
      <button (click)="toggleContentManager()">Gestor de Contenido</button>
      <button (click)="toggleDarkMode()">{{ darkMode ? '‚òÄÔ∏è' : 'üåô' }}</button>
      <button (click)="exportFlow()">Exportar</button>
      <label class="file-input">
        Importar
        <input type="file" accept="application/json" (change)="importFlow($event)" />
      </label>
    </div>
  </header>

  <section class="tutorial" *ngIf="showTutorial">
    <div class="tutorial-wrap">
      <div class="tutorial-content">
        <strong>Tutorial:</strong> {{ tutorialText() }}
        <button (click)="nextTutorialStep()">Siguiente paso</button>
      </div>
      <div class="demo-actions">
        <button *ngFor="let demo of demos; let i = index" (click)="loadDemo(i)">Cargar {{ demo.name }}</button>
      </div>
    </div>
    <button class="close-tutorial" (click)="closeTutorial()">‚úï</button>
  </section>

  <main class="workspace">
    <aside class="sidebar">
      <h2>Paleta de nodos</h2>
      <button
        *ngFor="let template of templates"
        [style.border-left-color]="template.color"
        (click)="addNode(template.type)">
        <span>{{ template.icon }}</span>
        {{ template.label }}
      </button>

      <details class="sidebar-section" open>
        <summary>Flujos guardados</summary>
        <div *ngFor="let flow of savedFlows" class="saved-item">
          <button (click)="loadFlow(flow.id)">{{ flow.name }}</button>
          <button class="danger" (click)="deleteFlow(flow.id)">‚úï</button>
        </div>
      </details>

      <h3>Conexi√≥n</h3>
      <p>{{ connectingHint }}</p>
      <button *ngIf="connectingFrom" (click)="cancelConnect()">Cancelar conexi√≥n</button>

      <details class="sidebar-section connection-list" *ngIf="connections.length" open>
        <summary>Conexiones</summary>
        <div
          *ngFor="let connection of connections"
          class="saved-item"
          [class.selected-item]="connection.id === selectedConnectionId"
          (click)="selectConnection(connection.id)">
          <small>{{ nodeLabel(connection.fromNodeId) }} ‚Üí {{ nodeLabel(connection.toNodeId) }} ({{ connection.fromPort }})</small>
          <button class="danger" (click)="removeConnection(connection.id); $event.stopPropagation()">‚úï</button>
        </div>
      </details>
    </aside>

    <section class="canvas-wrapper" (wheel)="onWheel($event)">
      <div class="canvas-transform" [style.transform]="'scale(' + zoom + ') translate(' + panX + 'px, ' + panY + 'px)'">
        <svg class="connections">
          <path *ngFor="let connection of connections" [attr.d]="connectionPath(connection)" [class.selected-connection]="connection.id === selectedConnectionId" (click)="selectConnection(connection.id)" />
        </svg>

        <div
          *ngFor="let node of nodes"
          class="node"
          [class.selected]="node.id === selectedNodeId"
          [class.active]="activeNodeIds.has(node.id)"
          [class.connect-target]="connectingFrom && connectingFrom.nodeId !== node.id"
          [style.left.px]="node.x"
          [style.top.px]="node.y"
          [style.border-color]="getNodeColor(node.type)"
          (click)="onNodeClick(node.id)">
          <div class="node-header" [style.background]="getNodeColor(node.type)" (mousedown)="onNodeDrag($event, node)">
            {{ node.data.label }}
          </div>
          <div class="node-body">
            <small>{{ node.type }}</small>
            <p class="node-description" *ngIf="node.data.description">{{ node.data.description }}</p>
            <div class="ports" *ngIf="node.type === 'decision'; else defaultPort">
              <button (click)="startConnect(node.id, 'true'); $event.stopPropagation()">Salida true</button>
              <button (click)="startConnect(node.id, 'false'); $event.stopPropagation()">Salida false</button>
            </div>
            <ng-template #defaultPort>
              <button (click)="startConnect(node.id, 'default'); $event.stopPropagation()">Salida</button>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Canvas Controls -->
      <div class="canvas-controls glass">
        <button (click)="zoomIn()" title="Zoom In">+</button>
        <span class="zoom-level">{{ (zoom * 100).toFixed(0) }}%</span>
        <button (click)="zoomOut()" title="Zoom Out">-</button>
        <button (click)="resetZoom()" title="Reset">‚ü≤</button>
      </div>
    </section>

    <aside class="properties" *ngIf="selectedNode as node; else connectionProperties">
      <h2>Configuraci√≥n de nodo</h2>
      <label>
        Etiqueta
        <input [(ngModel)]="node.data.label" (ngModelChange)="updateNode()" />
      </label>

      <label>
        Descripci√≥n
        <textarea [(ngModel)]="node.data.description" (ngModelChange)="updateNode()" rows="3" placeholder="Describe para qu√© sirve este nodo"></textarea>
      </label>

      <label *ngIf="node.type === 'decision'">
        Condici√≥n
        <input [(ngModel)]="node.data.condition" (ngModelChange)="updateNode()" placeholder="context.valor > 10" />
      </label>

      <label *ngIf="node.type === 'script'">
        Script JS/TS
        <textarea [(ngModel)]="node.data.script" (ngModelChange)="updateNode()" rows="6"></textarea>
      </label>

      <div class="script-tools" *ngIf="node.type === 'script'">
        <input [(ngModel)]="scriptDraftName" placeholder="Nombre para guardar script" />
        <button (click)="saveCurrentScript()">Guardar script</button>

        <select [(ngModel)]="selectedScriptId">
          <option [ngValue]="''">Seleccionar script guardado</option>
          <option *ngFor="let script of scriptLibrary" [value]="script.id">{{ script.name }}</option>
        </select>
        <button [disabled]="!selectedScriptId" (click)="applySavedScript(selectedScriptId)">Aplicar script guardado</button>

        <div class="saved-item" *ngFor="let script of scriptLibrary">
          <small>{{ script.name }}</small>
          <button class="danger" (click)="deleteSavedScript(script.id)">‚úï</button>
        </div>
      </div>

      <label *ngIf="node.type === 'api'">
        URL API
        <input [(ngModel)]="node.data.apiUrl" (ngModelChange)="updateNode()" placeholder="https://api.example.com" />
      </label>

      <label *ngIf="node.type === 'api'">
        M√©todo
        <select [(ngModel)]="node.data.apiMethod" (ngModelChange)="updateNode()">
          <option>GET</option>
          <option>POST</option>
        </select>
      </label>

      <label *ngIf="node.type === 'api' && node.data.apiMethod === 'POST'">
        Body
        <textarea [(ngModel)]="node.data.apiBody" (ngModelChange)="updateNode()" rows="5"></textarea>
      </label>

      <button class="danger" (click)="deleteSelectedNode()" style="width: 100%; margin-top: auto;">Eliminar nodo</button>
    </aside>

    <ng-template #connectionProperties>
      <aside class="properties" *ngIf="selectedConnection as connection">
        <h2>Configuraci√≥n de conexi√≥n</h2>
        <p><strong>Origen:</strong> {{ nodeLabel(connection.fromNodeId) }}</p>
        <p><strong>Destino:</strong> {{ nodeLabel(connection.toNodeId) }}</p>

        <label>
          Puerto de salida
          <select [(ngModel)]="connection.fromPort" (ngModelChange)="updateConnection()">
            <option value="default">default</option>
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </label>

        <label>
          Nodo destino
          <select [(ngModel)]="connection.toNodeId" (ngModelChange)="updateConnection()">
            <option *ngFor="let nodeOption of nodes" [value]="nodeOption.id" [disabled]="nodeOption.id === connection.fromNodeId">
              {{ nodeOption.data.label }}
            </option>
          </select>
        </label>

        <button class="danger" (click)="removeConnection(connection.id)" style="width: 100%; margin-top: auto;">Eliminar conexi√≥n</button>
      </aside>
    </ng-template>
  </main>

  <section class="bottom-panels">
    <article>
      <h3>Validaci√≥n</h3>
      <ul>
        <li *ngFor="let error of validationErrors">{{ error }}</li>
      </ul>
      <p *ngIf="!validationErrors.length">Sin errores de validaci√≥n.</p>
    </article>

    <article>
      <h3>Logs de ejecuci√≥n</h3>
      <ul>
        <li *ngFor="let line of logs">{{ line }}</li>
      </ul>
    </article>
  </section>

  <!-- Content Manager Modal -->
  <div class="modal-overlay" *ngIf="showContentManager" (click)="toggleContentManager()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Gestor de Contenido</h2>
        <button class="close-modal-btn" (click)="toggleContentManager()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="content-section">
          <h3>Flujos Guardados</h3>
          <div class="content-grid">
            <div *ngFor="let flow of savedFlows" class="content-card">
              <div class="card-info">
                <strong>{{ flow.name }}</strong>
                <small>{{ flow.updatedAt | date:'short' }}</small>
              </div>
              <div class="card-actions">
                <button (click)="loadFlow(flow.id); toggleContentManager()">Cargar</button>
                <button class="danger" (click)="deleteFlow(flow.id)">Borrar</button>
              </div>
            </div>
            <div *ngIf="savedFlows.length === 0" class="empty-state">No hay flujos guardados.</div>
          </div>
        </div>

        <div class="content-section">
          <h3>Biblioteca de Scripts</h3>
          <div class="content-grid">
            <div *ngFor="let script of scriptLibrary" class="content-card">
              <div class="card-info">
                <strong>{{ script.name }}</strong>
                <small>{{ script.updatedAt | date:'short' }}</small>
              </div>
              <div class="card-actions">
                <button (click)="applySavedScript(script.id); toggleContentManager()" [disabled]="!selectedNode || selectedNode.type !== 'script'">Aplicar</button>
                <button class="danger" (click)="deleteSavedScript(script.id)">Borrar</button>
              </div>
            </div>
            <div *ngIf="scriptLibrary.length === 0" class="empty-state">No hay scripts guardados.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
